{"componentChunkName":"component---src-templates-blog-post-js","path":"/testing-exported-functions-using-jest/","result":{"data":{"site":{"siteMetadata":{"title":"WhateverJS Blog"}},"markdownRemark":{"id":"0204df28-1190-5728-8ded-9dee608b651a","excerpt":"I’m starting to love Unit Testing, this old good practice adds so much value to any long-term product that I feel it should be mandatory in any software…","html":"<p>I’m starting to love Unit Testing, this old good practice adds so much value to any long-term product that I feel it should be mandatory in any software development team. I’ve realized that it increases your confidence as a software developer and helps your teammates to feel more comfortable when they review code because you are showing them what test cases you automated. And, I’m quite sure you will thank yourself in the future whenever you need or want to refactor some code.</p>\n<p>In this post I will show you a functional approach approach for testing named exported recursive functions using Jest.</p>\n<h3>Prerequisites</h3>\n<ol>\n<li>Have a good understanding about recursive functions, and how to code them.</li>\n<li>Might come handy to read what <a href=\"https://v2.parceljs.org/\" rel=\"noopener\" target=\"_blank\">Jest</a> does, how <a href=\"https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname\" rel=\"noopener\" target=\"_blank\">.spyOn</a> and <a href=\"https://jestjs.io/docs/en/jest-object#jestfnimplementation\" rel=\"noopener\" target=\"_blank\">.fn</a> methods work.</li>\n</ol>\n<h3>Let’s Do It</h3>\n<p>I’m going to present you a real case scenario I faced weeks ago where a request to an API to fetch geographic locations returned a geographic tree. For the sake of simplicity, I’m going to describe a small portion of the response.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber 0\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Belgium\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Brussels\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ixelles/Elsene\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Anderlecht\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"8\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Jette\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Antwerpen\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Geel\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Mechelen\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Sint-Katelijne-Waver\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The response in this case is 3 levels depth. Although the example seems to be simple this could scale to deeper levels, and the data structure could become expensive to manipulate/query/handle if you want to get the very last and deepest level location.</p>\n<p>Imagine for example,</p>\n<ol>\n<li>you need to present this geographical tree as a list where each item has the location’s <code class=\"language-text\">name</code> and its immediate parent’s <code class=\"language-text\">name</code>.</li>\n<li>you need to search a location by its name while the user types in an input, and show the matching results inside an autocomplete options list.</li>\n<li>you need to build a breadcrumb if the user picks/selects a location. An array where the last element is what the user has selected and the first is the root location (in this case Belgium).</li>\n</ol>\n<blockquote>\n<p>What would be the first thing to do?</p>\n</blockquote>\n<p>Well, from my perspective you will need a lookup table. It could be a <code class=\"language-text\">Map</code> or an <code class=\"language-text\">Object</code> where keys are the location ids and values are the locations as such.</p>\n<p>I’m going to show you the solution I implemented.</p>\n<p><strong>1st</strong>, I described the API’s request response using a Typescript interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token comment\">// Describes the API's response</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GeoTree</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n  name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  level<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n  children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> GeoTree<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>2nd</strong>, I implemented a recursive function that takes the geographical tree as 1st parameter and an instance of a <code class=\"language-text\">Map</code> (optional) as 2nd parameter.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token comment\">// Typescript types</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n  children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  parentId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span> <span class=\"token operator\">=</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">geoTreeToGeoMap</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span></span><span class=\"token punctuation\">(</span>\n  geoTreeNode<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  geoMap<span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> geoTreeNode<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> child <span class=\"token keyword\">of</span> geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      child<span class=\"token punctuation\">.</span>parentId <span class=\"token operator\">=</span> geoTreeNode<span class=\"token punctuation\">.</span>id\n      <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> geoMap<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> geoMap\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Quite simple solution, no? Now, in order test the <code class=\"language-text\">geoTreeToGeoMap</code> function I imported it into a <code class=\"language-text\">spec</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"geoTreeToGeoMap\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">should not add \"parentId to root location\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// geoTree is the object described in the beginning</span>\n    <span class=\"token keyword\">const</span> geoMap <span class=\"token operator\">=</span> <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeUndefined</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">should add \"parentId to each location's child\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> geoMap <span class=\"token operator\">=</span> <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>No big deal, so far.</p>\n<p>After testing the function’s results I decided to make assertions on how many times the function was being called. I thought that using <code class=\"language-text\">jest.fn</code> to wrap the original implementation and use it afterwards was the way to do it.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"geoTreeToGeoMap\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">afterAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    jest<span class=\"token punctuation\">.</span><span class=\"token function\">clearAllMocks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be called expected times\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> mockFn <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>geoTreeToGeoMap<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> geoMap <span class=\"token operator\">=</span> <span class=\"token function\">mockFn</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toStrictEqual</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>mockFn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalledTimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Unfortunately, the test could only track the first function’s call.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ffabf3a90e1c5fa31237e66a231b6533/cd536/recursive-function-test-failed.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABlklEQVQoz32SW3LDIAxFvYQ0ljFgzMt2HNd5NFPvf2u3EkkzTafTjzMSQlwkUNVbi22a8DnP2I5HfIwjPpltGJCOCsO1QVrZrhZxVkiLfpJ/+JFzW1ujIiI4QWs4YyAXhL5HwzHVNtCmZRS0Vahph5B6xOSZgJQD8nDHeVPyK2oaXniEGNGzkHvQdR1yzhi52pwyQogY8oAYE0yvoNwO2hH2+xpvb3vsGWMsqoYFO9uhdyzUOfYdLK9LrPfwTP+4wDnBwXRcdUelaqUaiIZ0arjDIjgeEuZ3rmSMWE4TpjnDB1fWMXtO1Kjr+gnVxDR3y0Ivgi0vjCfYUHMrhC6JT/zAVOLGyVveD/3Hi2Db6tIaUcMVUIEe1I8q/uNF0OkWI4/N6XTCkcdmXVccDgdMHEs5cWwu/rIsZV+sIJ+lFI9K2z4FLU9IJYEcQkmSBOF8PuN6vRZ7uVyK4O12w7ZtxX7vC1KAVCZvK1qVCMgPyiEJeB4hiZXHJ3qxv/mr7UrUNQ+1iIovZX+38hvJkxES5GLJ/ykoOV8YJiIWU99RXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Recursive function test failed\"\n        title=\"Recursive function test failed\"\n        src=\"/static/ffabf3a90e1c5fa31237e66a231b6533/fcda8/recursive-function-test-failed.png\"\n        srcset=\"/static/ffabf3a90e1c5fa31237e66a231b6533/12f09/recursive-function-test-failed.png 148w,\n/static/ffabf3a90e1c5fa31237e66a231b6533/e4a3f/recursive-function-test-failed.png 295w,\n/static/ffabf3a90e1c5fa31237e66a231b6533/fcda8/recursive-function-test-failed.png 590w,\n/static/ffabf3a90e1c5fa31237e66a231b6533/efc66/recursive-function-test-failed.png 885w,\n/static/ffabf3a90e1c5fa31237e66a231b6533/cd536/recursive-function-test-failed.png 1114w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The reason WHY is failing doesn’t point to Jest but to how named exported functions are transpiled to Javascript.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token string\">\"use strict\"</span>\n\nObject<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> <span class=\"token string\">\"__esModule\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  value<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nexports<span class=\"token punctuation\">.</span>geoTreeToGeoMap <span class=\"token operator\">=</span> geoTreeToGeoMap\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">,</span> geoMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  geoMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> geoTreeNode<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> child <span class=\"token keyword\">of</span> geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      child<span class=\"token punctuation\">.</span>parentId <span class=\"token operator\">=</span> geoTreeNode<span class=\"token punctuation\">.</span>id\n      <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> geoMap<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> geoMap\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>After linking both parts, I understood that spying an exported function that calls itself directly doesn’t reach the function used inside the function’s body because it points to a different memory reference.</p>\n<p>To solve this I could take one of the following solutions:</p>\n<ol>\n<li>declaring an object, assign the function to one of its properties, and use the object’s property reference inside the recursive function, or</li>\n<li>importing the recursive function back into its own module and use the imported function inside itself.</li>\n</ol>\n<p>Both solutions are well described in this <a href=\"https://stackoverflow.com/questions/45102677/testing-recursive-calls-in-jest\" rel=\"noopener\" target=\"_blank\">Stack Overflow question #45102677</a>.</p>\n<p>However, I find both solutions had caveats, here are my explanations.</p>\n<ol>\n<li>The first solution doesn’t play well in a front-end application because export default objects aren’t tree shakable AFAIK.</li>\n<li>The second solution produces to my taste a not pleasant code smell. It could be hard to understand WHY a module is importing into itself.</li>\n</ol>\n<p>Now, here is my solution.</p>\n<p>From a Functional Programming perspective the recursive function could be re-written to accept 3 parameters, being the 1st parameter the function used inside the function’s body. Then, a Factory function could be created to bind to the 1st parameter the same recursive function which produces a new function.</p>\n<p>The implementation using a Functional Programming approach is as follows:</p>\n<p><code class=\"language-text\">geoTreeToGeoMap.types.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n  children<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  parentId<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span> <span class=\"token operator\">=</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GeoTreeToGeoMapRecursive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  self<span class=\"token operator\">:</span> GeoTreeToGeoMapRecursive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  geoTreeNode<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  geoMap<span class=\"token operator\">?</span><span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GeoTreeToGeoMap</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  geoTreeNode<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  geoMap<span class=\"token operator\">?</span><span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">&amp;</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">geoTreeToGeoMap.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  GeoMap<span class=\"token punctuation\">,</span>\n  GeoMapElement<span class=\"token punctuation\">,</span>\n  GeoTreeToGeoMapRecursive<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./geoTreeToGeoMap.types\"</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">geoTreeToGeoMapRecursive</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span></span><span class=\"token punctuation\">(</span>\n  self<span class=\"token operator\">:</span> GeoTreeToGeoMapRecursive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  geoTreeNode<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  geoMap<span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> GeoMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> geoTreeNode<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> child <span class=\"token keyword\">of</span> geoTreeNode<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      child<span class=\"token punctuation\">.</span>parentId <span class=\"token operator\">=</span> geoTreeNode<span class=\"token punctuation\">.</span>id\n      <span class=\"token function\">self</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">,</span> geoMap<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> geoMap\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> geoTreeToGeoMapFactory <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">GeoMapElement<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  recursiveFn<span class=\"token operator\">:</span> GeoTreeToGeoMapRecursive<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">recursiveFn</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> recursiveFn<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> geoTreeToGeoMap<span class=\"token operator\">:</span> GeoTreeToGeoMap <span class=\"token operator\">=</span> <span class=\"token function\">geoTreeToGeoMapFactory</span><span class=\"token punctuation\">(</span>\n  geoTreeToGeoMapRecursive\n<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Then, in the <code class=\"language-text\">spec</code> file, the recursive function is wrapped with a jest mock using <code class=\"language-text\">jest.fn</code> and the Factory function uses the mock to produce the <code class=\"language-text\">geoTreeToGeoMap</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"function execution\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">afterAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    jest<span class=\"token punctuation\">.</span><span class=\"token function\">clearAllMocks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be called expected times\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Wrap the recursive implementation with a Spy to keep track of it recursive calls</span>\n    <span class=\"token keyword\">const</span> geoTreeToGeoMapRecursiveSpy <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>geoTreeToGeoMapRecursive<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> geoTreeToGeoMap<span class=\"token operator\">:</span> GeoTreeToGeoMap <span class=\"token operator\">=</span> <span class=\"token function\">geoTreeToGeoMapFactory</span><span class=\"token punctuation\">(</span>\n      geoTreeToGeoMapRecursiveSpy\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> geoMap <span class=\"token operator\">=</span> <span class=\"token function\">geoTreeToGeoMap</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoMap<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toStrictEqual</span><span class=\"token punctuation\">(</span>geoTree<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>geoTreeToGeoMapRecursiveSpy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalledTimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This way the function <code class=\"language-text\">geoTreeToGeoMapRecursiveSpy</code> can be used to make call’s assertions, and the tests passed.</p>\n<blockquote>\n<p>I hope you liked it.</p>\n</blockquote>","frontmatter":{"title":"Testing named exported recursive functions using Jest","date":"November 18, 2020","description":"In this post I will show you a functional approach approach for testing named exported recursive functions using Jest."},"fields":{"readingTime":{"text":"7 min read"}}}},"pageContext":{"slug":"/testing-exported-functions-using-jest/","previous":{"fields":{"slug":"/apprentices-will-not-understand-typescript/"},"frontmatter":{"title":"Apprentices won't understand Typescript, I heard"}},"next":null}},"staticQueryHashes":["414608701","63159454"]}